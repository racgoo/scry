"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const uuid_1=__importDefault(require("../utils/uuid"));const processedNodes=new WeakSet;function scryBabelPlugin({types:t}){const TRACE_MARKER="___SCRY_TRACED___";return{visitor:{Program:{enter(path,state){const filePath=(state===null||state===void 0?void 0:state.filename)||"";if(processedNodes.has(path.node)||filePath.includes("node_modules")){return}}},CallExpression:{exit(path,state){var _a;try{const callee=path.node.callee;if(t.isArrowFunctionExpression(callee)||((_a=path.node.leadingComments)===null||_a===void 0?void 0:_a.some((comment=>comment.value.includes(TRACE_MARKER))))){return}if(t.isIdentifier(callee)&&callee.name.startsWith("_jsx")||t.isMemberExpression(callee)&&t.isIdentifier(callee.object)&&callee.object.name==="React"){return}let parentTraceId=null;let chained=false;if(t.isMemberExpression(callee)&&t.isCallExpression(callee.object)){chained=true;const parentCallExp=callee.object;if(t.isArrowFunctionExpression(parentCallExp.callee)){const parentBody=parentCallExp.callee.body;if(t.isBlockStatement(parentBody)&&parentBody.body.length>0){const firstStmt=parentBody.body[0];if(t.isVariableDeclaration(firstStmt)&&firstStmt.declarations.length>0&&t.isIdentifier(firstStmt.declarations[0].id)){parentTraceId=firstStmt.declarations[0].id.name}}}}let fnName="anonymous";if(t.isIdentifier(callee)){fnName=callee.name}else if(t.isMemberExpression(callee)&&t.isIdentifier(callee.property)){fnName=callee.property.name}const newNode=t.callExpression(t.arrowFunctionExpression([],t.blockStatement([t.variableDeclaration("const",[t.variableDeclarator(t.identifier("traceId"),t.stringLiteral(uuid_1.default.generateV4()))]),t.expressionStatement(t.assignmentExpression("=",t.memberExpression(t.identifier("globalThis"),t.identifier("__currentTraceId")),t.identifier("traceId"))),t.expressionStatement(t.callExpression(t.memberExpression(t.identifier("globalThis"),t.identifier("dispatchEvent")),[t.newExpression(t.identifier("CustomEvent"),[t.stringLiteral("scry:trace"),t.objectExpression([t.objectProperty(t.identifier("detail"),t.objectExpression([t.objectProperty(t.identifier("type"),t.stringLiteral("enter")),t.objectProperty(t.identifier("name"),t.stringLiteral(fnName)),t.objectProperty(t.identifier("returnValue"),t.nullLiteral()),t.objectProperty(t.identifier("traceId"),t.identifier("traceId")),t.objectProperty(t.identifier("source"),t.stringLiteral(`${(state===null||state===void 0?void 0:state.filename)||""}:${path.node.loc?`${path.node.loc.start.line}:${path.node.loc.start.column}`:"unknown"}`)),t.objectProperty(t.identifier("chained"),t.booleanLiteral(chained)),t.objectProperty(t.identifier("parentTraceId"),parentTraceId?t.identifier(parentTraceId):t.nullLiteral()),t.objectProperty(t.identifier("args"),t.arrayExpression(path.node.arguments.map((arg=>{if(t.isArrowFunctionExpression(arg)||t.isFunctionExpression(arg)){let location="";if(arg.loc){location=`${arg.loc.start.line}:${arg.loc.start.column}-${arg.loc.end.line}:${arg.loc.end.column}`}let params="";if(arg.params&&arg.params.length>0){params=arg.params.length+"개 파라미터"}let name="익명";if(t.isFunctionExpression(arg)&&arg.id&&arg.id.name){name=arg.id.name}let filePath=(state===null||state===void 0?void 0:state.filename)||"";if(filePath&&filePath.includes("/")){filePath=filePath.split("/").slice(-2).join("/")}return t.stringLiteral(`함수 ${name} (${filePath}:${location}) ${params}`)}else if(t.isStringLiteral(arg)){return t.stringLiteral(`"${arg.value}"`)}else if(t.isNumericLiteral(arg)){return t.stringLiteral(`${arg.value}`)}else if(t.isObjectExpression(arg)){return t.stringLiteral("{객체}")}else{return t.stringLiteral(`${arg.type||"알 수 없음"}`)}}))))]))])])])),t.variableDeclaration("const",[t.variableDeclarator(t.identifier("parentTraceId"),t.logicalExpression("??",t.memberExpression(t.identifier("globalThis"),t.identifier("__parentTraceId")),t.nullLiteral()))]),t.expressionStatement(t.assignmentExpression("=",t.memberExpression(t.identifier("globalThis"),t.identifier("__parentTraceId")),t.identifier("traceId"))),t.variableDeclaration("const",[t.variableDeclarator(t.identifier("returnValue"),t.callExpression(callee,path.node.arguments))]),t.expressionStatement(t.assignmentExpression("=",t.memberExpression(t.identifier("globalThis"),t.identifier("__parentTraceId")),t.identifier("parentTraceId"))),t.expressionStatement(t.callExpression(t.memberExpression(t.identifier("globalThis"),t.identifier("dispatchEvent")),[t.newExpression(t.identifier("CustomEvent"),[t.stringLiteral("scry:trace"),t.objectExpression([t.objectProperty(t.identifier("detail"),t.objectExpression([t.objectProperty(t.identifier("type"),t.stringLiteral("exit")),t.objectProperty(t.identifier("name"),t.stringLiteral(fnName)),t.objectProperty(t.identifier("traceId"),t.identifier("traceId")),t.objectProperty(t.identifier("source"),t.stringLiteral(`${(state===null||state===void 0?void 0:state.filename)||""}:${path.node.loc?`${path.node.loc.start.line}:${path.node.loc.start.column}`:"unknown"}`)),t.objectProperty(t.identifier("returnValue"),t.identifier("returnValue")),t.objectProperty(t.identifier("chained"),t.booleanLiteral(chained)),t.objectProperty(t.identifier("parentTraceId"),parentTraceId?t.identifier(parentTraceId):t.nullLiteral()),t.objectProperty(t.identifier("args"),t.arrayExpression(path.node.arguments.map((arg=>{if(t.isArrowFunctionExpression(arg)||t.isFunctionExpression(arg)){let location="";if(arg.loc){location=`${arg.loc.start.line}:${arg.loc.start.column}-${arg.loc.end.line}:${arg.loc.end.column}`}let params="";if(arg.params&&arg.params.length>0){params=arg.params.length+"개 파라미터"}let name="익명";if(t.isFunctionExpression(arg)&&arg.id&&arg.id.name){name=arg.id.name}let filePath=(state===null||state===void 0?void 0:state.filename)||"";if(filePath&&filePath.includes("/")){filePath=filePath.split("/").slice(-2).join("/")}return t.stringLiteral(`함수 ${name} (${filePath}:${location}) ${params}`)}else if(t.isStringLiteral(arg)){return t.stringLiteral(`"${arg.value}"`)}else if(t.isNumericLiteral(arg)){return t.stringLiteral(`${arg.value}`)}else if(t.isObjectExpression(arg)){return t.stringLiteral("{객체}")}else{return t.stringLiteral(`${arg.type||"알 수 없음"}`)}}))))]))])])])),t.returnStatement(t.identifier("returnValue"))])),[]);newNode.leadingComments=[{type:"CommentBlock",value:` ${TRACE_MARKER} `}];path.replaceWith(newNode);path.skip()}catch(error){console.error("Babel plugin error:",error)}}}}}}exports.default=scryBabelPlugin;"use strict";Object.defineProperty(exports,"__esModule",{value:true});class Output{static print(...args){console.log(`[SCRY]:`,...args)}}exports.default=Output;"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const output_1=__importDefault(require("./output"));class Tracer{constructor(){this.isTracing=false;this.details=[];this.boundOnTrace=this.onTrace.bind(this)}start(){if(this.isTracing){output_1.default.print("이미 추적이 진행 중입니다. Tracer.end()를 먼저 호출해주세요.");return}this.isTracing=true;globalThis.addEventListener("scry:trace",this.boundOnTrace);output_1.default.print("추적 시작")}end(){if(!this.isTracing){output_1.default.print("추적이 진행 중이지 않습니다. Tracer.start()를 먼저 호출해주세요.");return}this.isTracing=false;globalThis.removeEventListener("scry:trace",this.boundOnTrace);const tree=this.makeTree(this.details);output_1.default.print("추적 종료");output_1.default.print("실행 트리",tree);this.details=[];return tree}onTrace(event){this.details.push(event.detail)}makeTree(details){const tree=[];const nodeMap=new Map;const callStack=[];for(let i=0;i<details.length;i++){const detail=details[i];if(detail.type==="enter"){const node={traceId:detail.traceId,name:detail.name,source:detail.source,args:detail.args||[],children:[],timestamp:0,completed:false,chained:detail.chained,parentTraceId:detail.parentTraceId};nodeMap.set(detail.traceId,node);callStack.push(detail.traceId);if(callStack.length>1){const parentId=callStack[callStack.length-2];const parent=nodeMap.get(parentId);if(parent&&!parent.completed){parent.children.push(node)}else{tree.push(node)}}else{tree.push(node)}}else if(detail.type==="exit"){const node=nodeMap.get(detail.traceId);if(node){node.returnValue=detail.returnValue;node.completed=true;node.duration=0;const stackIndex=callStack.lastIndexOf(detail.traceId);if(stackIndex!==-1){callStack.splice(stackIndex,1)}}}}tree.pop();return tree}}exports.default=Tracer;"use strict";Object.defineProperty(exports,"__esModule",{value:true});const uuid_1=require("uuid");class UUID{static generateV4(){return(0,uuid_1.v4)()}}exports.default=UUID;